
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Python Packaging - Codematician</title>
  <meta name="author" content="Andy R. Terrel">

  
  <meta name="description" content="There are two major hurdles to Python disrupting the entire HPC work stack:
packaging and dynamic loading. Today I want to discuss the packaging &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://andy.terrel.us/blog/2012/10/25/python-packaging/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Codematician" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-388278-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Codematician</a></h1>
  
    <h2>Homepage of Andy R. Terrel, PhD</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:andy.terrel.us" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/vita">Vita</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Python Packaging</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-25T14:42:00-04:00" pubdate data-updated="true">Oct 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>There are two major hurdles to Python disrupting the entire HPC work stack:
packaging and dynamic loading. Today I want to discuss the packaging issue.
While there are many people working on these hurdles, it is my opinion that the
community needs to seek out methods to solve these hurdles together in a
satisfactory way. I see this problem taking shape in many different
communities, but the HPC version of the problem is probably the most difficult,
thus by solving it, we can provide solutions for many other communities as well.</p>

<p>To this end, I helped host a conference call among the young, enthusiastic
NumFOCUS community.  This call seemed much more of a get to know the problem
rather than a listing of solutions.  We are working on editting the call and
hope to have it published as a InSCIght podcast soon.  The call included
several companies that produces packaged Python solutions, university folks
from around the globe, and industrial users of Python.  The interest in the
call was so great that we had to switch mediums at the last moment and lost out
on some interactions with other great folks.  I hope to have another call in
the future and a discussion at the upcoming SuperComputing 2013 conference.</p>

<h2>What is wrong with Python Packaging</h2>

<p>Perhaps the place to start is defining the problem.  When you have a piece of
code in a pure Python setting, one easily adds the top source directory to
<code>PYTHONPATH</code> and happily imports away.  This model works quite well
usually. For the first years of Google App engine, code could only be installed
in this manner.</p>

<p>The issue is that in HPC one must depend upon libraries that are highly tuned
for specifics of the architecture where the code is run.  These highly tuned
libraries often include assembly and usually only include compiled static or
shared libraries.  Since, HPC often uses specific compilers dedicated to their
hardware, these libraries depend on the formats compatible with those
compilers.  To further enhance the problem, if these libraries are distributed
via MPI, then the libraries depend on the MPI implementation (which depends
upon the compiler).  At TACC we have a hierarchical module system to keep this
all straight.  You load the compiler, then the MPI implementation, and finally
any libraries.  If you switch to a different compiler, the entire stack is
reloaded.  Actually a big part of my job is to make sure these stacks are all
compiled in a way that they can be switched out, something that is a feat with
biology codes. In a nutshell, we have a huge dependency chain that is binary
and machine dependent.</p>

<p>Python isn&#8217;t supporting this long list of dependencies very well.  For HPCers
this is not new as we are use to having to hack build and package systems.  In
fact in the eight years I&#8217;ve been around the FEniCS community, I&#8217;ve seen four
package systems come and go.  It took me three weeks to get the Trilinos code
installed on my system back in 2006, at the time folks opined that picking that
the right Trilinos configure was NP-Hard. It is much better today. In both cases
though, CMake has turned out to be the tool that has stabilized everything.</p>

<p>Why can&#8217;t Python support this jumble of dependencies?  The reasons are many,
but as David Carnepeau has pointed out, Python fundamentally mixes both build
and packaging together in a way that makes it impossibly hard.  I don&#8217;t know
David&#8217;s history, but he seems pretty critical of the community about not
understanding the issue.  Rather than rehash all the arguments, I&#8217;m going to
outline my view of the solution, separating build and packaging.</p>

<h2>The build process</h2>

<p>The difficult part of the build process is not calling the compiler, rather
configuring the environment and compiler flags to produce the desired binary.</p>

<p>To give a simple example, if you are compiling a threaded library, say using
OpenMP, you need to know that gcc uses -fopenmp, icc uses -openmp, pgi
-xopenmp, something else on xl, and clang doesn&#8217;t even support it.  Thank you
Apple for making my job that much harder by using a default compiler that
doesn&#8217;t support OpenMP.</p>

<p>Okay that&#8217;s actually not hard to code, but it gets better.  Because multicore
threading is still an infant technology, if you compose several threaded
libraries you can see a real performance degradation (despite @dbeaz thinking
threading is easy). Thus most vendors provide a threaded version of BLAS and a
sequential version, the idea being if you have a big matrix to work with make
BLAS be the multithreaded portion of the code, but if you have lots of smaller
matrices let the application be multithreaded.  This means that each
application could be built with 4 compilers X 2 BLAS threading modes, we also
need to throw in debugging and optimized modes as yes -O3 versus -g -O0 really
do matter.</p>

<p>In this trivial example, we already need to test 16 different builds of a
library, not to mention figuring out how many threads to run (which is often a
runtime decision with OpenMP). If you want to drive your graduate students to
madness get them to install Scalapack on your cluster.</p>

<p>At this point, you might say &#8220;16 versions of the library, quit your crying,
baby!&#8221;. It should be easy to script except Python distribution tools really
don&#8217;t give a way to manage these different compiler flags.  In many cases the
tools just slaps your code in some place on the path and runs all sorts of
bootstrapping patching hacks to install at all.  Virtualenv give a bit of sanity as
one can isolate different Python builds, but it doesn&#8217;t handle any of the
system libraries at all.  It is my understanding that when EPD was built, they
initially tried to fix this problem but quickly switched to a single binary
only distribution model.</p>

<p>To tackle all these burdens, we need to start using real configure and build
tools.  They need to work on all platforms, yes Windows matters in HPC. They
need to be free and open source. And they actually already exist, the community
just needs to start adopting them and that will take some effort.  The two
tools I&#8217;ve seen used well are Bento produced by David and CMake produced by
Kitware.  I&#8217;m not going to have a bake-off on the pros and cons of each, I have
far more experience with CMake but people I trust tell me Bento is far easier
to use. If NumFOCUS and the PSF really wants to help the community today, it
would start helping people augment distutils to use one of these tools.</p>

<h2>The package selection process</h2>

<p>Now that we&#8217;ve discussed the build process, we need to package up those builds
and allow developers to use them.  I was really glad the Yaroslav, one of the
Debian developers, and Samuel, homebrew&#8217;s Python guy, was able to join us on
the call.  Open source platforms have created great packaging tools, but it
only gets us code monkeys about halfway.  I can install the basic libraries
that aren&#8217;t cutting edge and don&#8217;t need fine grain configuration system
wide. Then I just keep the jumbled mess in my developer space.  But what if a
developer needs to fix a bug with one of those system installed libraries that
isn&#8217;t the version installed? I&#8217;ve spend more time futzing with the packaging
system installer than fixing the bug.</p>

<p>The truth of the matter is we really want the jumbled mess to be managed better
too.  Just like on my supercomputer, I can issue a single command and have a
whole new compiler stack working, why can&#8217;t I do that with my current
development tree.  Here enters HashDist.  HashDist is Dag and Ondrej&#8217;s plan for
fixing this problem.  The idea is to build libraries and stash them some place,
recording the necessary details in a small distribution file that is hashed and
put in a database store.  Now when you need to build different versions of a library,
one can simply refer to the different hashes of the other built libraries. At
this point, HashDist is vaporware that has some funding.  I have been working
with these guys trying to fund this project for about a year and a half.</p>

<p>Let me be frank.  If this tool existed, reporting bugs could come with a
hashdist number that would set your machine up in the bug state immediately,
i.e., no more futzing with installers just working.  For HPC systems this would
be huge. Hell it is even a good idea for a SAAS startup company.</p>

<p>This is very similar to the module system that we use at TACC, lmod, but it
should build into the development cycle not just running a supercomputer.  For
what its worth, supercomputers use module systems because when you have 5000
users on a machine, you have to keep the kids from stepping on each others
toes.</p>

<h2>Why this affects developers outside of HPC</h2>

<p>Hopefully, I&#8217;ve explained the problem well enough and pointed to a few
promising fixes.  While these problems are accentuated in HPC systems, they
exist everywhere.  Every single company, I have consulted with has this
problem.  They solve it different ways, but they all manage their own build and
packaging system.  Every single open source scientific Python team, has this
problems.  They usually solve it the old fashioned way, indentured servants, err
graduate students.  But perhaps more importantly, as PyPy and other python
distributions threaten CPython for popularity, even Python core is having these
problems. The wheel proposals are a good first step, but its gonna take more
than changing package names to fix it.</p>

<p>NumFOCUS was founded to help encourage businesses and institutions to put
funding together to solve science software problems. This is a big problem and
one that prevents a large number of people from effectively using our
ecosystem.  I would like to see more funds and community resources put forward
to create working solutions. Finally a homework for everyone who has read this
far. I invite you to send me your versions of how you fix Python
packaging for your work so I can collect the best ideas.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andy R. Terrel</span></span>

      








  


<time datetime="2012-10-25T14:42:00-04:00" pubdate data-updated="true">Oct 25<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/packaging/'>Packaging</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://andy.terrel.us/blog/2012/10/25/python-packaging/" data-via="aterrel" data-counturl="http://andy.terrel.us/blog/2012/10/25/python-packaging/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/10/08/thoughts-on-the-scipy-conference/" title="Previous Post: Thoughts on the SciPy Conference">&laquo; Thoughts on the SciPy Conference</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/10/28/python-packaging/" title="Next Post: Python Packaging">Python Packaging &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Dr. Andy R. Terrel is a High Performance Computing researcher at the <a href="http://www.tacc.utexas.edu">Texas Advanced Computing Center</a>. In this role, Andy helps users utilize supercomputers with Python and studies methods for speeding up computational fluid dynamics. He graduated from the University of Chicago with a PhD in Computer Science in 2010 and has been programming in Python for the last decade. Andy has contributed to numerous open source projects notably the <a href="http://fenicsproject.org">FEniCS Project</a> and <a href="http://sympy.org">Sympy</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/28/python-packaging/">Python Packaging</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/25/python-packaging/">Python Packaging</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/08/thoughts-on-the-scipy-conference/">Thoughts on the SciPy Conference</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/starting-with-python/">Getting started with Python in HPC</a>
      </li>
    
  </ul>
</section>

<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/106486100774697058597?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("aterrel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/aterrel" class="twitter-follow-button" data-show-count="false">Follow @aterrel</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/aterrel">@aterrel</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'aterrel',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Andy R. Terrel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andyrterrelhomepage';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://andy.terrel.us/blog/2012/10/25/python-packaging/';
        var disqus_url = 'http://andy.terrel.us/blog/2012/10/25/python-packaging/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
